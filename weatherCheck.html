<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Weather Viewer</title>
		<style type="text/css">
        * { margin:0; padding:0; }

        body {
            margin: 0.9rem;
            color: white;
            text-shadow: -0.05em -0.05em black, -0.05em 0.05em black, 0.05em -0.05em black, 0.05em 0.05em black;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
            height: 100%;
            min-height: 100%;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center center;
            font: 18px sans-serif;
        }

        .centered {
            width: 100%;
            text-align: center;
        }
        
        .conditions {
            z-index:2;
            height:100px;
            position: fixed;   
        }
        
        #searchResults {
            float: left;
            position:relative;
            top: 100px;
        }

        td {
			padding-left: .2rem;
			padding-right: .2rem;
			text-align: center;
		}
		</style>

		<meta name="author" content="Patrick Schieszer">
		<meta name="description" content="Weather checker">
		<meta name="robots" content="all">
	</head>
	<script>
	const inHgPerPa = 0.0002953;
    const COMMA = "%2C";
    const HOME_LOC = "38.6270074,-90.1912848";
	const hourFormat = { weekday: 'short', hour: 'numeric'};
	const hourMinFormat = { weekday: 'short', hour: 'numeric', minute: 'numeric' };
	
	getDateString = (date, dateFormat) => new Intl.DateTimeFormat('en-US', dateFormat).format(date);
	
	formatDate = (date, dateFormat = hourFormat) => (date instanceof Date) ? getDateString(date, dateFormat) : date;
	
	buildCell = x => {
		const td = document.createElement('TD');
		td.appendChild(x);
		return td;
	};
	
	buildTextCell = x => buildCell(document.createTextNode(x));
	
	buildImage = (src, text) => {
		const img = new Image();
		img.src = src;
		img.title = img.alt = text;
		return img;
	};
        
    getDateRange = (start, end) => formatDate(start) + " to " + formatDate(end);
	
	addRow = (image, imageAlt, start, temp, end, wind) => {
		const tableBody = document.getElementById("searchResults").children[0];
		const tr = document.createElement('TR');
		const td = (image && image.length > 0) ? 
			buildCell(buildImage(image, imageAlt)) : buildTextCell(image);
		tr.appendChild(td);
		
		const elemTexts = [ getDateRange(start, end), temp, wind ];
		elemTexts.map(buildTextCell).forEach(x => tr.appendChild(x));
		tableBody.appendChild(tr);
	};
	
	getDate = strDate => new Date(strDate);
	
	getWind = period => period.windDirection + " " + period.windSpeed;

	parseForecast = jsonResp => {
		addRow("", undefined, "Start", "Temp", "End", "Wind");
		if (jsonResp.properties && jsonResp.properties.periods) {
			jsonResp.properties.periods.forEach(currPeriod =>
				addRow(currPeriod.icon, currPeriod.shortForecast, getDate(currPeriod.startTime),
				       currPeriod.temperature, getDate(currPeriod.endTime), getWind(currPeriod)));
		}
	};
	
	formattedNum = x => Number.parseFloat(x).toFixed(2);
	
	getFarenheit = x => (x * 9/5) + 32;
	
	setText = (tag, text) => document.getElementById(tag).innerText = text;
        
    getWindChill = windChill => (windChill < 31) ? ", " + windChill + "F wind chill" : "";
    
    getConditionsText = (desc, temp, windChill) => desc + ", " + temp + "F degrees" + getWindChill(windChill);

    setImage = imgSrc => document.body.style.backgroundImage = "url(" + imgSrc + ")";

    parseConditions = jsonResp => {
		if (jsonResp.properties && jsonResp.properties.barometricPressure && jsonResp.properties.barometricPressure.value) {
			const inHg = jsonResp.properties.barometricPressure.value * inHgPerPa;
			setText("barometricPressure", formattedNum(inHg) + " inches Hg");
			const windChill = formattedNum(getFarenheit(jsonResp.properties.windChill.value));
			const currTemp = formattedNum(getFarenheit(jsonResp.properties.temperature.value));
            const desc = jsonResp.properties.textDescription;
			setText("currTemp", getConditionsText(desc, currTemp, windChill));
			setText("currTime", formatDate(getDate(jsonResp.properties.timestamp), hourMinFormat));
            setImage(jsonResp.properties.icon.replace("medium", "large"));
		}
	};
	
	stateChange = (ajax, callback) =>
		() => {
			if (ajax.readyState == 4){
				if (ajax.status == 200) {
					callback(JSON.parse(ajax.responseText));
				} else {
					console.log("Received HTTP code " + ajax.status + " on response");
				}
			}
		};

	startCall = (url, callback) => {
		const xmlHttp = new XMLHttpRequest();
		xmlHttp.onreadystatechange = stateChange(xmlHttp, callback);
		xmlHttp.open("GET", url, true); // true for asynchronous
		xmlHttp.setRequestHeader("accept", "application/geo+json");
		xmlHttp.send();
	};
        
    getPosition = callback => {
        const enteredLoc = document.getElementById("currLocation").value;
        const DEF_LOC = (enteredLoc) ? enteredLoc : HOME_LOC;
        if (!enteredLoc && 'geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(x => callback(x.coords.latitude + COMMA + x.coords.longitude),
                                                     err => callback(DEF_LOC));
        } else {
            callback(DEF_LOC);
        }
    };
        
    parseStationInfo = stationInfo => setText("locationName", stationInfo.properties.name);
        
    getMyConditions = stations => {
        const closestStation = stations.features[0].properties.stationIdentifier;
        startCall("https://api.weather.gov/stations/" + closestStation, parseStationInfo);
		startCall("https://api.weather.gov/stations/" + closestStation + "/observations/latest", parseConditions);
    }
        
    getStation = () => {
        const tableBody = document.getElementById("searchResults").children[0];
        const rowCount = tableBody.children.length;
        if (rowCount > 0) Array.from(Array(rowCount)).forEach(x => tableBody.deleteRow(0));
        getPosition(pos => {
            document.getElementById("currLocation").value = pos;
            startCall("https://api.weather.gov/points/" + pos + "/stations", getMyConditions);
            startCall("https://api.weather.gov/points/" + pos + "/forecast/hourly", parseForecast);
        });
    }
		
	window.onload = () => {
        const button = document.querySelector('#refresh');
        button.addEventListener('click', getStation);
        const locField = document.querySelector('#currLocation');
        locField.addEventListener('change', getStation);
        getStation();
    }
	</script>
	<body>
        <div class="conditions centered">
            <label for="location">Location: </label><input type="text" id="currLocation" name="location">
            <input type="button" value="Refresh" id="refresh">
            <div><h3>Weather</h3> (conditions as of <span id="currTime"></span> @ <span id="locationName"></span>)</div>
            <div id="currTemp"></div>
            <div id="barometricPressure"></div>
        </div>
        <table id="searchResults" class="centered">
            <tbody />
        </table>
	</body>
</html>